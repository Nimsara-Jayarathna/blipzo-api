# Blipzo API v1.1.0 Documentation

## Base URL
`http://<host>:<port>/api/v1.1`

## Content Type
- Requests: `application/json`
- Responses: `application/json` (except 204 No Content)

## Admin Endpoints (v1.1)

All admin endpoints are under:

`/api/v1.1/admin`

### Admin Auth

- `POST /admin/auth/login`
- `GET /admin/auth/session`
- `POST /admin/auth/logout`

### Admin Dashboard

- `GET /admin/dashboard`

Query params:

- `period` (`30d | 90d`)
- `eventsLimit` (integer, `1..50`)

### Admin Users

- `GET /admin/users` (admin-auth required)
- `GET /admin/users/:id` (admin-auth required)
- `PATCH /admin/users/:id` (admin-auth required)
- `GET /admin/users/:id/activity` (admin-auth required)
- `POST /admin/users/:id/reset-password` (admin-auth required)
- `POST /admin/users/:id/force-logout` (admin-auth required)

Purpose:

- Returns app users for the admin Users management table.
- Uses the admin response envelope (`success`, `message`, `data`, `meta`).

Optional query params:

- `name`
- `email`
- `userId`
- `status` (`ACTIVE | INACTIVE | SUSPENDED`)

Response `data`:

- `users`: array of `{ id, name, email, status }`
- `total`: number of returned users

`GET /admin/users/:id` response `data`:

- `id`, `name`, `email`, `status`, `categoryLimit`, `defaultCurrency`, `createdAt`, `lastLoginAt`, `role`

`PATCH /admin/users/:id` request body:

- `email` (optional, unique)
- `status` (optional: `ACTIVE | INACTIVE | SUSPENDED`)
- `categoryLimit` (optional integer `0..1000`)

`GET /admin/users/:id/activity` response `data`:

- `activity`: array of `{ event, details, date }`

`POST /admin/users/:id/reset-password` behavior:

- Generates random temporary password.
- Hashes and stores in user password.
- Sets `mustChangePassword = true`.
- Increments `tokenVersion` (invalidates active tokens).
- Sends temporary password email.

`POST /admin/users/:id/force-logout` behavior:

- Increments `tokenVersion` only (token invalidation strategy without session table).

### Admin Currencies

- `GET /admin/currencies` (admin-auth required)
- `GET /admin/currencies/:id` (admin-auth required)
- `POST /admin/currencies` (admin-auth required)
- `PATCH /admin/currencies/:id` (admin-auth required)
- `POST /admin/currencies/:id/set-default` (admin-auth required)
- `POST /admin/currencies/:id/toggle-status` (admin-auth required)

`GET /admin/currencies` optional query params:

- `code`
- `name`
- `symbol`
- `status` (`ALL | DEFAULT | ENABLED | DISABLED`)

Response `data`:

- `currencies`: array of `{ id, code, name, symbol, isActive, isDefault, status }`
- `total`: number of returned currencies

`POST /admin/currencies` and `PATCH /admin/currencies/:id` request body:

- `code` (required for create, uppercase 2-10 letters, unique)
- `name` (required for create)
- `symbol` (required for create)
- `isActive` (boolean)
- `isDefault` (boolean)

Rules:

- Default currency is always active.
- Disabling default currency is rejected.

### Admin Categories

- `GET /admin/categories` (admin-auth required)
- `POST /admin/categories` (admin-auth required)
- `PATCH /admin/categories/:id` (admin-auth required)
- `POST /admin/categories/:id/set-default` (admin-auth required)
- `DELETE /admin/categories/:id` (admin-auth required)
- `PATCH /admin/categories/settings` (admin-auth required)

`GET /admin/categories` response `data`:

- `defaults.income`, `defaults.expense`: active default categories for each type.
- `settings.defaultCategoryLimit`: global registration-time category limit.
- `categories`: active global template categories.
- `total`: category count.

Category payload (`POST` and `PATCH`):

- `name` (required)
- `type` (`income | expense`)
- `setAsDefault` (boolean)

Category settings payload:

- `defaultCategoryLimit` (integer `1..1000`)

Behavior:

- This configuration is a global template used during **new user registration**.
- Existing users keep independent category data after account creation.

## Authentication and Session
v1.1.0 uses **HTTP-only cookies** for authentication, identical to v1.0.

- Cookie names: `accessToken`, `refreshToken`
- Tokens are set on: `POST /auth/register/complete`, `POST /auth/login`, `POST /auth/refresh`
- Tokens are cleared on: `POST /auth/logout`
- Access token is required for protected routes via cookie (no Authorization header is used).

Token and cookie settings (configurable via env):
- Access token TTL: `ACCESS_TOKEN_EXPIRES_IN` (default `15m`)
- Refresh token TTL: `REFRESH_TOKEN_EXPIRES_IN` (default `7d`)
- Cookie flags: `COOKIE_SAMESITE` (default `lax`), `COOKIE_SECURE` (default `true` unless set to `false`), `COOKIE_DOMAIN` (optional)

## Rate Limiting
Rate limits are applied per IP and return standard `RateLimit-*` headers.

- Global limiter (all routes):  
  `GLOBAL_LIMIT_WINDOW_MS` (default 1 minute), `GLOBAL_LIMIT_MAX` (default 100)
- Auth limiter (login/register/verify/reset):  
  `AUTH_LIMIT_WINDOW_MS` (default 1 minute), `AUTH_LIMIT_MAX` (default 5)  
  Skips successful requests (`skipSuccessfulRequests: true`)
- Email limiter (email sending endpoints):  
  `EMAIL_LIMIT_WINDOW_MS` (default 10 minutes), `EMAIL_LIMIT_MAX` (default 3)

When throttled:
- v1.1 response uses standardized error envelope with code `RATE_LIMIT_EXCEEDED`.

## Response Formats (v1.1)

### 1) Standardized Endpoints (new in v1.1)
All **new** v1.1 endpoints use a standardized response envelope.

**Success:**
```json
{
  "success": true,
  "message": "Operation successful",
  "data": { "...": "..." }
}
```

**Error:**
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "Readable message",
    "details": {}
  }
}
```

### 2) Inherited Endpoints (v1.0 behavior)
Endpoints inherited from v1.0 (auth, categories, transactions) keep **raw success responses** but use **standardized errors** when accessed via `/api/v1.1`.

## Error Codes (v1.1)
The standardized error envelope may use the following codes:
- `AUTH_INVALID_CREDENTIALS`
- `AUTH_TOKEN_EXPIRED`
- `AUTH_UNAUTHORIZED`
- `AUTH_FORBIDDEN`
- `USER_ALREADY_EXISTS`
- `USER_NOT_FOUND`
- `VALIDATION_ERROR`
- `INVALID_INPUT`
- `RESOURCE_NOT_FOUND`
- `RESOURCE_ALREADY_EXISTS`
- `INTERNAL_SERVER_ERROR`
- `SERVICE_UNAVAILABLE`
- `RATE_LIMIT_EXCEEDED`
- `UNPROCESSABLE_ENTITY`

Note: some v1.1 service errors only provide an HTTP status and message; in those cases the `code` may default to `INTERNAL_SERVER_ERROR` even when the status is 4xx.

## Common Data Shapes

### User
```json
{
  "id": "64f...",
  "name": "Jane Doe",
  "fname": "Jane",
  "lname": "Doe",
  "email": "jane@example.com",
  "status": "ACTIVE",
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-02T00:00:00.000Z",
  "categoryLimit": 10,
  "defaultIncomeCategories": ["Sales"],
  "defaultExpenseCategories": ["Stock"],
  "currency": {
    "id": "65a...",
    "name": "US Dollar",
    "code": "USD",
    "symbol": "$"
  }
}
```

### Category
```json
{
  "id": "65b...",
  "name": "Groceries",
  "type": "expense",
  "isDefault": false,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-02T00:00:00.000Z",
  "isGlobal": false
}
```

### Transaction
```json
{
  "id": "65c...",
  "_id": "65c...",
  "user": "64f...",
  "title": "Groceries",
  "description": "Weekly shopping",
  "note": "Weekly shopping",
  "type": "expense",
  "category": "Groceries",
  "categoryName": "Groceries",
  "categoryId": "65b...",
  "amount": 120.5,
  "date": "2024-01-01T00:00:00.000Z",
  "status": "active",
  "isCustomDate": false,
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-02T00:00:00.000Z"
}
```

## New Endpoints (Standardized v1.1)

### Registration Flow

#### Register Init
- **POST** `/auth/register/init`
- **Rate limit:** Email limiter + global limiter
- **Body (JSON):**
  - `email` (string, required)
- **Response: 200**
```json
{
  "success": true,
  "message": "Registration initiated",
  "data": {
    "message": "OTP sent successfully"
  }
}
```
- **Errors:** `400` missing email, `409` already registered

#### Register Verify (OTP)
- **POST** `/auth/register/verify`
- **Rate limit:** Auth limiter + global limiter
- **Body (JSON):**
  - `email` (string, required)
  - `otp` (string, required, 6 digits)
- **Notes:** OTP expires in about 10 minutes.
- **Response: 200**
```json
{
  "success": true,
  "message": "OTP verified",
  "data": {
    "registrationToken": "token_..."
  }
}
```
- **Errors:** `400` invalid/expired OTP

#### Register Complete
- **POST** `/auth/register/complete`
- **Rate limit:** Auth limiter + global limiter
- **Body (JSON):**
  - `registrationToken` (string, required)
  - `fname` (string, required)
  - `lname` (string, required)
  - `password` (string, required)
  - `name` (string, optional)
- **Notes:** The `registrationToken` expires in about 10 minutes.
- **Behavior:**
  - Creates default categories: `Sales` (income), `Stock` (expense)
  - Assigns default currency if one is marked `isDefault`
  - Sets auth cookies
- **Response: 201**
```json
{
  "success": true,
  "message": "Authentication successful",
  "data": {
    "user": { "...": "..." }
  }
}
```
- **Errors:** `400` invalid/expired registration session, `409` email already registered

### Password Management

#### Forgot Password
- **POST** `/auth/password/forgot`
- **Rate limit:** Email limiter + global limiter
- **Body (JSON):**
  - `email` (string, required)
  - `platform` (string, optional: `web` | `mobile`, default `web`)
- **Response: 200**
```json
{
  "success": true,
  "message": "Password reset email sent",
  "data": {
    "message": "If that email exists, a reset link has been sent."
  }
}
```
- **Notes:**
  - Reset token TTL is ~1 hour.
  - Link destination is platform-specific:
    - `web`: `${CLIENT_URL}/reset-password?token=...`
    - `mobile`: `${MB_APP_URI_SCHEME}://auth/reset-password?token=...`
- **Errors:** `400` invalid platform

#### Reset Password
- **POST** `/auth/password/reset`
- **Rate limit:** Auth limiter + global limiter
- **Body (JSON):**
  - `token` (string, required)
  - `password` (string, required)
- **Response: 200**
```json
{
  "success": true,
  "message": "Password reset successfully",
  "data": {
    "message": "Password reset successfully"
  }
}
```
- **Errors:** `400` invalid/expired token, `400` user not found

#### Change Password
- **POST** `/auth/password/change`
- **Auth:** Required
- **Rate limit:** Email limiter + global limiter
- **Body (JSON):**
  - `currentPassword` (string, required)
  - `newPassword` (string, required)
- **Response: 200**
```json
{
  "success": true,
  "message": "Password changed successfully",
  "data": {
    "message": "Password changed successfully"
  }
}
```
- **Errors:** `400` missing fields, `401` incorrect current password, `404` user not found

### Email Change Flow
OTP tokens expire in ~10 minutes.

#### Initiate Email Change
- **POST** `/auth/email/change/init`
- **Auth:** Required
- **Rate limit:** Email limiter + global limiter
- **Response: 200**
```json
{
  "success": true,
  "message": "Email change initiated",
  "data": {
    "message": "Verification code sent to current email"
  }
}
```

#### Verify Current Email
- **POST** `/auth/email/change/verify-current`
- **Auth:** Required
- **Body (JSON):**
  - `otp` (string, required)
- **Response: 200**
```json
{
  "success": true,
  "message": "Current email verified",
  "data": {
    "changeToken": "token_..."
  }
}
```
- **Errors:** `400` invalid/expired OTP

#### Request New Email
- **POST** `/auth/email/change/request-new`
- **Auth:** Required
- **Rate limit:** Email limiter + global limiter
- **Body (JSON):**
  - `changeToken` (string, required)
  - `newEmail` (string, required)
- **Response: 200**
```json
{
  "success": true,
  "message": "Verification email sent to new address",
  "data": {
    "message": "Verification code sent to new email"
  }
}
```
- **Errors:** `403` invalid/expired change token, `409` email already in use

#### Confirm New Email
- **POST** `/auth/email/change/confirm`
- **Auth:** Required
- **Body (JSON):**
  - `otp` (string, required)
- **Response: 200**
```json
{
  "success": true,
  "message": "Email changed successfully",
  "data": {
    "message": "Email updated successfully",
    "email": "new@example.com"
  }
}
```
- **Errors:** `400` invalid/expired OTP

### User Profile

#### Update User Details
- **PUT** `/auth/me`
- **Auth:** Required
- **Body (JSON):**
  - `fname` (string, optional)
  - `lname` (string, optional)
- **Response: 200**
```json
{
  "success": true,
  "message": "User details updated",
  "data": {
    "user": { "...": "..." }
  }
}
```
- **Errors:** `404` user not found

### Currencies

#### List Currencies
- **GET** `/currencies`
- **Auth:** Required
- **Response: 200**
```json
{
  "success": true,
  "message": "Currencies retrieved successfully",
  "data": {
    "currencies": [
      {
        "_id": "65d...",
        "name": "US Dollar",
        "code": "USD",
        "symbol": "$",
        "isDefault": true,
        "isSelected": true,
        "createdAt": "2024-01-01T00:00:00.000Z",
        "updatedAt": "2024-01-02T00:00:00.000Z",
        "__v": 0
      }
    ]
  }
}
```

#### Update User Currency
- **PUT** `/users/currency`
- **Auth:** Required
- **Body (JSON):**
  - `currencyId` (string, required)
- **Response: 200**
```json
{
  "success": true,
  "message": "Currency updated successfully",
  "data": {
    "currency": {
      "id": "65d...",
      "name": "US Dollar",
      "code": "USD",
      "symbol": "$"
    }
  }
}
```
- **Errors:** `400` missing/invalid currency ID, `404` user not found

## Inherited Endpoints (v1.0 behavior with v1.1 errors)
The following endpoints behave like v1.0 for success responses, but use standardized errors when accessed via `/api/v1.1`.

### Authentication (Legacy)

#### Login
- **POST** `/auth/login`
- **Rate limit:** Auth limiter + global limiter
- **Body (JSON):**
  - `email` (string, required)
  - `password` (string, required)
- **Success: 200** (raw)
```json
{
  "user": { "...": "..." }
}
```
- **Errors:** `400` missing fields, `401` invalid credentials (standardized error envelope)

#### Register (Legacy)
- **POST** `/auth/register`
- **Rate limit:** Auth limiter + global limiter
- **Body (JSON):**
  - `fname` (string, required)
  - `lname` (string, required)
  - `email` (string, required)
  - `password` (string, required)
  - `name` (string, optional)
- **Success: 201** (raw)
```json
{
  "user": { "...": "..." }
}
```
- **Errors:** `400` missing fields, `409` already registered (standardized error envelope)

#### Get Current User
- **GET** `/auth/me`
- **Auth:** Required
- **Success: 200** (raw)
```json
{
  "user": { "...": "..." }
}
```
- **Errors:** `401` missing/invalid token, `419` expired access token (standardized error envelope)

#### Get Session
- **GET** `/auth/session`
- **Auth:** Access token cookie required
- **Success: 200** (raw)
```json
{
  "user": { "...": "..." }
}
```
- **Errors:** `401` missing/invalid token, `419` expired access token (standardized error envelope)

#### Refresh Session
- **POST** `/auth/refresh`
- **Auth:** Refresh token cookie required
- **Success: 200** (raw)
```json
{
  "user": { "...": "..." }
}
```
- **Errors:** `401` invalid refresh token, `419` expired refresh token (standardized error envelope)

#### Logout
- **POST** `/auth/logout`
- **Success:** `204 No Content`

### Categories (Legacy)
All category routes require authentication. Success responses are raw JSON, errors are standardized.

#### List Active Categories
- **GET** `/categories/active`
- **Query Params (optional):**
  - `type` = `income` | `expense`
- **Notes:** Returns both user categories and global categories (where `isGlobal` is true).
- **Success: 200** (raw)
```json
{
  "categories": [ { "...": "..." } ],
  "limit": 10
}
```
- **Errors:** `400` invalid `type`

#### List All Categories
- **GET** `/categories/all`
- **Query Params (optional):** `type`
- **Success: 200** (raw)
```json
{
  "categories": [ { "...": "..." } ],
  "limit": 10
}
```
- **Errors:** `400` invalid `type`

#### Create Category
- **POST** `/categories`
- **Body (JSON):**
  - `name` (string, required)
  - `type` (string, required: `income` | `expense`)
- **Behavior:**
  - Enforces user category limit (includes global + user categories)
  - Reactivates an archived category if it exists
- **Success:**
  - `201` when created
  - `200` when reactivated
```json
{
  "category": { "...": "..." },
  "reactivated": true
}
```
- **Errors:** `400` invalid input or limit reached, `409` category already exists

#### Set Default Category
- **PATCH** `/categories/:id`
- **Body (JSON):**
  - `isDefault` must be `true`
- **Success: 200** (raw)
```json
{
  "category": { "...": "..." },
  "defaults": {
    "defaultIncomeCategories": ["Sales"],
    "defaultExpenseCategories": ["Stock"]
  },
  "unchanged": false
}
```
- **Errors:** `400` invalid input or inactive category, `404` not found

#### Archive Category
- **DELETE** `/categories/:id`
- **Success: 200** (raw)
```json
{
  "category": { "...": "..." },
  "archived": true
}
```
- **Errors:** `400` default category cannot be removed, `404` not found

### Transactions (Legacy)
All transaction routes require authentication. Success responses are raw JSON, errors are standardized.

#### Create Transaction
- **POST** `/transactions`
- **Body (JSON):**
  - `type` (required: `income` | `expense`)
  - `amount` (required, positive number)
  - `category` (string, optional if `categoryId` provided)
  - `categoryId` (string, optional, must be valid ID)
  - `title` (string, optional)
  - `description` or `note` (string, optional)
  - `date` (string, optional, ISO date; stored at UTC midnight)
  - `status` (string, optional: `active` | `undone`)
- **Behavior:**
  - If `categoryId` is absent, `category` is matched by name.
  - If both are missing, defaults to user default category for the `type`.
  - If `category` is a valid ObjectId string and `categoryId` is not provided, it is treated as a category ID.
- **Success: 201** (raw)
```json
{
  "transaction": { "...": "..." }
}
```
- **Errors:** `400` invalid input, `404` category not found
  - Also `400` for invalid `categoryId` or inactive category

#### Create Transaction (Custom Date Required)
- **POST** `/transactions/custom`
- **Body:** Same as create transaction, but `date` is required.
- **Success:** `201` with raw `transaction`.
- **Errors:** `400` missing/invalid `date`

#### List Transactions
- **GET** `/transactions`
- **Query Params (all optional):**
  - `page` (int > 0)
  - `pageSize` (int > 0)
  - `status` = `active` | `undone`
  - `startDate` (ISO date, inclusive)
  - `endDate` (ISO date, inclusive)
  - `type` = `income` | `expense`
  - `category` (string, case-insensitive match)
  - `sortBy` = `date` | `amount` | `category` (default `date`)
  - `sortDir` = `asc` | `desc` (default `desc`)
- **Success: 200** (raw)
```json
{
  "transactions": [ { "...": "..." } ],
  "total": 25,
  "page": 1,
  "pageSize": 10
}
```
If `page` and `pageSize` are missing or invalid, pagination fields are omitted:
```json
{
  "transactions": [ { "...": "..." } ]
}
```
- **Errors:** `400` invalid filter values

#### Get Summary
- **GET** `/transactions/summary`
- **Notes:** Summary includes only transactions with `status = "active"`.
- **Success: 200** (raw)
```json
{
  "totalIncome": 5000,
  "totalExpense": 2000,
  "balance": 3000,
  "monthlySummary": [
    { "month": "2024-01", "income": 1000, "expense": 300 }
  ],
  "weeklySummary": [
    { "week": "2024-W01", "income": 500, "expense": 200 }
  ],
  "yearlySummary": [
    { "year": 2024, "income": 5000, "expense": 2000 }
  ]
}
```

#### Update Transaction
- **PUT** `/transactions/:id`
- **Body (JSON):** Any of the create fields plus:
  - `isCustomDate` (boolean, optional; if `false`, resets date to now)
- **Success: 200** (raw)
```json
{
  "transaction": { "...": "..." }
}
```
- **Errors:** `400` invalid input, `404` transaction not found
  - Also `400` for invalid `categoryId` or inactive category

#### Delete Transaction
- **DELETE** `/transactions/:id`
- **Timezone (required):**
  - Header: `X-Timezone` (preferred) or `X-User-Timezone`
  - Query param: `timezone`
  - Body: `timezone`
- **Behavior:** Only allowed if transaction date is "today" in the provided timezone.
- **Success:** `204 No Content`
- **Errors:** `400` missing/invalid timezone, `403` forbidden, `404` not found, `409` date is not today
