# Blipzo API v1.0.0 Documentation

## Base URL
`http://<host>:<port>/api/v1`

## Content Type
- Requests: `application/json`
- Responses: `application/json` (except 204 No Content)

## Authentication and Session
v1.0.0 uses **HTTP-only cookies** for authentication.

- Cookie names: `accessToken`, `refreshToken`
- Tokens are set on: `POST /auth/register`, `POST /auth/login`, `POST /auth/refresh`
- Tokens are cleared on: `POST /auth/logout`
- Access token is required for protected routes via cookie (no Authorization header is used).

Token and cookie settings (configurable via env):
- Access token TTL: `ACCESS_TOKEN_EXPIRES_IN` (default `15m`)
- Refresh token TTL: `REFRESH_TOKEN_EXPIRES_IN` (default `7d`)
- Cookie flags: `COOKIE_SAMESITE` (default `lax`), `COOKIE_SECURE` (default `true` unless set to `false`), `COOKIE_DOMAIN` (optional)

## Rate Limiting
Rate limits are applied per IP and return standard `RateLimit-*` headers.

- Global limiter (all routes):  
  `GLOBAL_LIMIT_WINDOW_MS` (default 1 minute), `GLOBAL_LIMIT_MAX` (default 100)
- Auth limiter (login/register):  
  `AUTH_LIMIT_WINDOW_MS` (default 1 minute), `AUTH_LIMIT_MAX` (default 5)  
  Skips successful requests (`skipSuccessfulRequests: true`)

When throttled:
- v1.0 response: `{ "status": 429, "message": "Too many requests from this IP, please try again later" }`

## Response Formats (v1.0)

### Success (raw JSON)
Success responses return the data directly (no envelope).

### Error (legacy)
Errors return a simple object:
```json
{
  "message": "Invalid credentials",
  "errors": { "field": "message" },
  "stack": "..." 
}
```
- `errors` appears for validation cases.
- `stack` appears only when `NODE_ENV` is not `production`.

## Common Data Shapes

### User
Returned by auth endpoints (sanitized).
```json
{
  "id": "64f...",
  "name": "Jane Doe",
  "fname": "Jane",
  "lname": "Doe",
  "email": "jane@example.com",
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-02T00:00:00.000Z",
  "categoryLimit": 10,
  "defaultIncomeCategories": ["Sales"],
  "defaultExpenseCategories": ["Stock"],
  "currency": {
    "id": "65a...",
    "name": "US Dollar",
    "code": "USD",
    "symbol": "$"
  }
}
```
Note: `currency` may be `null` or incomplete if not populated.

### Category
```json
{
  "id": "65b...",
  "name": "Groceries",
  "type": "expense",
  "isDefault": false,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-02T00:00:00.000Z",
  "isGlobal": false
}
```

### Transaction
```json
{
  "id": "65c...",
  "_id": "65c...",
  "user": "64f...",
  "title": "Groceries",
  "description": "Weekly shopping",
  "note": "Weekly shopping",
  "type": "expense",
  "category": "Groceries",
  "categoryName": "Groceries",
  "categoryId": "65b...",
  "amount": 120.5,
  "date": "2024-01-01T00:00:00.000Z",
  "status": "active",
  "isCustomDate": false,
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-02T00:00:00.000Z"
}
```

## Endpoints

### Authentication

#### Register
- **POST** `/auth/register`
- **Rate limit:** Auth limiter + global limiter
- **Body (JSON):**
  - `fname` (string, required)
  - `lname` (string, required)
  - `email` (string, required)
  - `password` (string, required)
  - `name` (string, optional)
- **Behavior:**
  - Creates default categories: `Sales` (income), `Stock` (expense)
  - Assigns default currency if one is marked `isDefault`
  - Sets auth cookies
- **Response: 201**
```json
{
  "user": { "...": "..." }
}
```
- **Errors:**
  - `400` if required fields missing
  - `409` if email already registered

#### Login
- **POST** `/auth/login`
- **Rate limit:** Auth limiter + global limiter
- **Body (JSON):**
  - `email` (string, required)
  - `password` (string, required)
- **Behavior:** Sets auth cookies.
- **Response: 200**
```json
{
  "user": { "...": "..." }
}
```
- **Errors:** `400` missing fields, `401` invalid credentials

#### Get Current User
- **GET** `/auth/me`
- **Auth:** Required (access token cookie)
- **Response: 200**
```json
{
  "user": { "...": "..." }
}
```
- **Errors:** `401` missing/invalid token, `419` expired access token

#### Get Session (Access Token Only)
- **GET** `/auth/session`
- **Auth:** Access token cookie required (no refresh)
- **Response: 200**
```json
{
  "user": { "...": "..." }
}
```
- **Errors:** `401` missing/invalid token, `419` expired access token

#### Refresh Session
- **POST** `/auth/refresh`
- **Auth:** Refresh token cookie required
- **Behavior:** Issues new access + refresh tokens and sets cookies.
- **Response: 200**
```json
{
  "user": { "...": "..." }
}
```
- **Errors:** `401` invalid refresh token, `419` expired refresh token

#### Logout
- **POST** `/auth/logout`
- **Response:** `204 No Content` (clears cookies)

---

### Categories
All category routes require authentication.

#### List Active Categories
- **GET** `/categories/active`
- **Query Params (optional):**
  - `type` = `income` | `expense`
- **Notes:** Returns both user categories and global categories (where `isGlobal` is true).
- **Response: 200**
```json
{
  "categories": [ { "...": "..." } ],
  "limit": 10
}
```
- **Errors:** `400` invalid `type`

#### List All Categories
- **GET** `/categories/all`
- **Query Params (optional):** `type`
- **Response: 200**
```json
{
  "categories": [ { "...": "..." } ],
  "limit": 10
}
```
- **Errors:** `400` invalid `type`

#### Create Category
- **POST** `/categories`
- **Body (JSON):**
  - `name` (string, required)
  - `type` (string, required: `income` | `expense`)
- **Behavior:**
  - Enforces user category limit (includes global + user categories)
  - Reactivates an archived category if it exists
- **Response:**
  - `201` when created
  - `200` when reactivated
```json
{
  "category": { "...": "..." },
  "reactivated": true
}
```
- **Errors:** `400` invalid input or limit reached, `409` category already exists

#### Set Default Category
- **PATCH** `/categories/:id`
- **Body (JSON):**
  - `isDefault` must be `true`
- **Response: 200**
```json
{
  "category": { "...": "..." },
  "defaults": {
    "defaultIncomeCategories": ["Sales"],
    "defaultExpenseCategories": ["Stock"]
  },
  "unchanged": false
}
```
- **Errors:** `400` invalid input or inactive category, `404` not found

#### Archive Category
- **DELETE** `/categories/:id`
- **Response: 200**
```json
{
  "category": { "...": "..." },
  "archived": true
}
```
- **Errors:** `400` default category cannot be removed, `404` not found

---

### Transactions
All transaction routes require authentication.

#### Create Transaction
- **POST** `/transactions`
- **Body (JSON):**
  - `type` (required: `income` | `expense`)
  - `amount` (required, positive number)
  - `category` (string, optional if `categoryId` provided)
  - `categoryId` (string, optional, must be valid ID)
  - `title` (string, optional)
  - `description` or `note` (string, optional)
  - `date` (string, optional, ISO date; stored at UTC midnight)
  - `status` (string, optional: `active` | `undone`)
- **Behavior:**
  - If `categoryId` is absent, `category` is matched by name.
  - If both are missing, defaults to user default category for the `type`.
  - If `category` is a valid ObjectId string and `categoryId` is not provided, it is treated as a category ID.
- **Response: 201**
```json
{
  "transaction": { "...": "..." }
}
```
- **Errors:** `400` invalid input, `404` category not found
  - Also `400` for invalid `categoryId` or inactive category

#### Create Transaction (Custom Date Required)
- **POST** `/transactions/custom`
- **Body:** Same as create transaction, but `date` is required.
- **Response:** `201` with `transaction`.
- **Errors:** `400` missing/invalid `date`

#### List Transactions
- **GET** `/transactions`
- **Query Params (all optional):**
  - `page` (int > 0)
  - `pageSize` (int > 0)
  - `status` = `active` | `undone`
  - `startDate` (ISO date, inclusive)
  - `endDate` (ISO date, inclusive)
  - `type` = `income` | `expense`
  - `category` (string, case-insensitive match)
  - `sortBy` = `date` | `amount` | `category` (default `date`)
  - `sortDir` = `asc` | `desc` (default `desc`)
- **Response: 200**
```json
{
  "transactions": [ { "...": "..." } ],
  "total": 25,
  "page": 1,
  "pageSize": 10
}
```
If `page` and `pageSize` are missing or invalid, pagination fields are omitted:
```json
{
  "transactions": [ { "...": "..." } ]
}
```
- **Errors:** `400` invalid filter values

#### Get Summary
- **GET** `/transactions/summary`
- **Notes:** Summary includes only transactions with `status = "active"`.
- **Response: 200**
```json
{
  "totalIncome": 5000,
  "totalExpense": 2000,
  "balance": 3000,
  "monthlySummary": [
    { "month": "2024-01", "income": 1000, "expense": 300 }
  ],
  "weeklySummary": [
    { "week": "2024-W01", "income": 500, "expense": 200 }
  ],
  "yearlySummary": [
    { "year": 2024, "income": 5000, "expense": 2000 }
  ]
}
```

#### Update Transaction
- **PUT** `/transactions/:id`
- **Body (JSON):** Any of the create fields plus:
  - `isCustomDate` (boolean, optional; if `false`, resets date to now)
- **Response: 200**
```json
{
  "transaction": { "...": "..." }
}
```
- **Errors:** `400` invalid input, `404` transaction not found
  - Also `400` for invalid `categoryId` or inactive category

#### Delete Transaction
- **DELETE** `/transactions/:id`
- **Timezone (required):**
  - Header: `X-Timezone` (preferred) or `X-User-Timezone`
  - Query param: `timezone`
  - Body: `timezone`
- **Behavior:** Only allowed if transaction date is "today" in the provided timezone.
- **Response:** `204 No Content`
- **Errors:** `400` missing/invalid timezone, `403` forbidden, `404` not found, `409` date is not today
